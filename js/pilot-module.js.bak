// é©¾é©¶å‘˜æ¨¡å—åŠŸèƒ½
class PilotModule {
    constructor() {
        this.currentUser = null;
        this.isLoggedIn = false;
        this.init();
    }

    init() {
        this.initEventListeners();
        this.loadUserData();
        this.updateUI();
    }

    initEventListeners() {
        // è¯­è¨€åˆ‡æ¢å™¨äº‹ä»¶
        const langCurrent = document.getElementById('langCurrent');
        const langDropdown = document.getElementById('langDropdown');
        
        if (langCurrent && langDropdown) {
            langCurrent.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelector('.language-switcher').classList.toggle('active');
            });
        }

        // é©¾é©¶å‘˜æ¨¡å—äº‹ä»¶
        const pilotTrigger = document.getElementById('pilotTrigger');
        const pilotDropdown = document.getElementById('pilotDropdown');
        
        if (pilotTrigger && pilotDropdown) {
            pilotTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelector('.pilot-module').classList.toggle('active');
            });
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.language-switcher')) {
                document.querySelector('.language-switcher')?.classList.remove('active');
            }
            if (!e.target.closest('.pilot-module')) {
                document.querySelector('.pilot-module')?.classList.remove('active');
            }
        });

        // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
        const modalOverlay = document.getElementById('modalOverlay');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    this.closeModal();
                }
            });
        }
    }

    loadUserData() {
        // ä»localStorageåŠ è½½ç”¨æˆ·æ•°æ®
        const userData = localStorage.getItem('warkAI_user');
        if (userData) {
            try {
                this.currentUser = JSON.parse(userData);
                this.isLoggedIn = true;
            } catch (e) {
                console.error('ç”¨æˆ·æ•°æ®è§£æå¤±è´¥:', e);
                localStorage.removeItem('warkAI_user');
            }
        }
    }

    updateUI() {
        const pilotName = document.getElementById('pilotName');
        const pilotStatus = document.getElementById('pilotStatus');
        
        if (this.isLoggedIn && this.currentUser) {
            if (pilotName) pilotName.textContent = this.currentUser.name || 'é©¾é©¶å‘˜';
            if (pilotStatus) {
                pilotStatus.textContent = 'å·²è®¤è¯';
                pilotStatus.classList.add('authenticated');
            }
        } else {
            if (pilotName) pilotName.textContent = 'è®¿å®¢é©¾é©¶å‘˜';
            if (pilotStatus) {
                pilotStatus.textContent = 'æœªè®¤è¯';
                pilotStatus.classList.remove('authenticated');
            }
        }
    }

    showModal(content) {
        const modalOverlay = document.getElementById('modalOverlay');
        const modalContainer = document.getElementById('modalContainer');
        
        if (modalOverlay && modalContainer) {
            modalContainer.innerHTML = content;
            modalOverlay.classList.add('active');
            
            // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
            const closeBtn = modalContainer.querySelector('.modal-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => this.closeModal());
            }
        }
    }

    closeModal() {
        const modalOverlay = document.getElementById('modalOverlay');
        if (modalOverlay) {
            modalOverlay.classList.remove('active');
        }
    }

    showProfile() {

    showLogin() {
        const loginContent = `
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="menu-icon">ğŸ”</span>
                    ç™»å½•ç³»ç»Ÿ
                </h2>
                <p class="modal-subtitle">ç™»å½•ä»¥è®¿é—®æ›´å¤šåŠŸèƒ½</p>
                <button class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">é©¾é©¶å‘˜å§“å</label>
                        <input type="text" class="form-input" id="loginName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é‚®ç®±åœ°å€</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="form-button secondary" onclick="pilotModule.closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="form-button">ç™»å½•</button>
                    </div>
                </form>
            </div>
        `;
        this.showModal(loginContent);
        
        setTimeout(() => {
            const form = document.getElementById('loginForm');
            if (form) {
                form.addEventListener('submit', (e) => this.submitLogin(e));
            }
        }, 100);
    }

    submitLogin(e) {
        e.preventDefault();
        const name = document.getElementById('loginName').value;
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        if (!name || !email || !password) {
            alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼');
            return;
        }
        
        const userData = {
            name: name,
            email: email,
            password: password,
            loginTime: new Date().toISOString()
        };
        
        localStorage.setItem('warkAI_user', JSON.stringify(userData));
        this.currentUser = userData;
        this.isLoggedIn = true;
        this.updateUI();
        this.closeModal();
        alert('ç™»å½•æˆåŠŸï¼');
    }
        const profileContent = `
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="menu-icon">ğŸ‘¤</span>
                    ä¸ªäººä¸­å¿ƒ
                </h2>
                <p class="modal-subtitle">ç®¡ç†æ‚¨çš„é©¾é©¶å‘˜æ¡£æ¡ˆ</p>
                <button class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                ${this.isLoggedIn ? this.getProfileForm() : this.getLoginPrompt()}
            </div>
        `;
        this.showModal(profileContent);
        
        // æ·»åŠ è¡¨å•æäº¤äº‹ä»¶
        setTimeout(() => {
            const form = document.getElementById('profileForm');
            if (form) {
                form.addEventListener('submit', (e) => this.submitProfile(e));
            }
        }, 100);
    }

    submitProfile(e) {
        e.preventDefault();
        const userName = document.getElementById('userName').value;
        const userEmail = document.getElementById('userEmail').value;
        const userCompany = document.getElementById('userCompany').value;
        const userPosition = document.getElementById('userPosition').value;
        
        const userData = {
            name: userName,
            email: userEmail,
            company: userCompany,
            position: userPosition
        };
        
        localStorage.setItem('warkAI_user', JSON.stringify(userData));
        this.currentUser = userData;
        this.isLoggedIn = true;
        this.updateUI();
        this.closeModal();
        alert('ä¸ªäººä¿¡æ¯å·²ä¿å­˜ï¼');
    }

    getProfileForm() {
        return `
            <form id="profileForm">
                <div class="form-group">
                    <label class="form-label">é©¾é©¶å‘˜å§“å</label>
                    <input type="text" class="form-input" id="userName" value="${this.currentUser?.name || ''}" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                </div>
                <div class="form-group">
                    <label class="form-label">é‚®ç®±åœ°å€</label>
                    <input type="email" class="form-input" id="userEmail" value="${this.currentUser?.email || ''}" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
                </div>
                <div class="form-group">
                    <label class="form-label">å…¬å¸/ç»„ç»‡</label>
                    <input type="text" class="form-input" id="userCompany" value="${this.currentUser?.company || ''}" placeholder="è¯·è¾“å…¥å…¬å¸æˆ–ç»„ç»‡åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">èŒä½</label>
                    <input type="text" class="form-input" id="userPosition" value="${this.currentUser?.position || ''}" placeholder="è¯·è¾“å…¥èŒä½">
                </div>
                <div class="modal-footer">
                    <button type="button" class="form-button secondary" onclick="pilotModule.logout()">é€€å‡ºç™»å½•</button>
                    <button type="submit" class="form-button">ä¿å­˜æ›´æ”¹</button>
                </div>
            </form>
        `;
    }

    getLoginPrompt() {
        return `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”</div>
                <h3 style="color: #ffffff; margin-bottom: 16px;">è¯·å…ˆç™»å½•ç³»ç»Ÿ</h3>
                <p style="color: #aaaaaa; margin-bottom: 24px;">ç™»å½•åå¯ä»¥ç®¡ç†ä¸ªäººä¿¡æ¯ã€ä¿å­˜åå¥½è®¾ç½®</p>
                <div class="modal-footer">
                    <button type="button" class="form-button" onclick="window.location.href='login.html'">å‰å¾€ç™»å½•</button>
                </div>
            </div>
        `;
    }

    submitFeedback(e) {
        e.preventDefault();
        const feedbackType = document.getElementById('feedbackType').value;
        const feedbackTitle = document.getElementById('feedbackTitle').value;
        const feedbackContent = document.getElementById('feedbackContent').value;
        const feedbackEmail = document.getElementById('feedbackEmail').value;
        
        if (!feedbackTitle || !feedbackContent) {
            alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹ï¼');
            return;
        }
        
        const feedback = {
            type: feedbackType,
            title: feedbackTitle,
            content: feedbackContent,
            email: feedbackEmail,
            timestamp: new Date().toISOString()
        };
        
        // ä¿å­˜åé¦ˆåˆ°localStorage
        let feedbacks = JSON.parse(localStorage.getItem('warkAI_feedbacks') || '[]');
        feedbacks.push(feedback);
        localStorage.setItem('warkAI_feedbacks', JSON.stringify(feedbacks));
        
        this.closeModal();
        alert('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼æˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚');
    }

    showFeedback() {
        const feedbackContent = `
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="menu-icon">ğŸ’¬</span>
                    æ„è§åé¦ˆ
                </h2>
                <p class="modal-subtitle">æ‚¨çš„å»ºè®®å¯¹æˆ‘ä»¬å¾ˆé‡è¦</p>
                <button class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <div class="form-group">
                        <label class="form-label">åé¦ˆç±»å‹</label>
                        <select class="form-input" id="feedbackType">
                            <option value="bug">é—®é¢˜æŠ¥å‘Š</option>
                            <option value="feature">åŠŸèƒ½å»ºè®®</option>
                            <option value="improvement">æ”¹è¿›å»ºè®®</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="feedbackTitle" placeholder="è¯·ç®€è¦æè¿°é—®é¢˜æˆ–å»ºè®®">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¯¦ç»†æè¿°</label>
                        <textarea class="form-input form-textarea" id="feedbackContent" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„åé¦ˆå†…å®¹..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è”ç³»é‚®ç®± (å¯é€‰)</label>
                        <input type="email" class="form-input" id="feedbackEmail" value="${this.currentUser?.email || ''}" placeholder="å¦‚éœ€å›å¤è¯·ç•™ä¸‹é‚®ç®±">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="form-button secondary" onclick="pilotModule.closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="form-button">æäº¤åé¦ˆ</button>
                    </div>
                </form>
            </div>
        `;
        this.showModal(feedbackContent);
        
        // æ·»åŠ è¡¨å•æäº¤äº‹ä»¶
        setTimeout(() => {
            const form = document.getElementById('feedbackForm');
            if (form) {
                form.addEventListener('submit', (e) => this.submitFeedback(e));
            }
        }, 100);
    }

    submitCooperation(e) {
        e.preventDefault();
        const cooperationType = document.getElementById('cooperationType').value;
        const coopCompany = document.getElementById('coopCompany').value;
        const coopContact = document.getElementById('coopContact').value;
        const coopEmail = document.getElementById('coopEmail').value;
        const coopPhone = document.getElementById('coopPhone').value;
        const coopDetails = document.getElementById('coopDetails').value;
        
        if (!coopEmail || !coopDetails) {
            alert('è¯·å¡«å†™é‚®ç®±å’Œåˆä½œæ„å‘ï¼');
            return;
        }
        
        const cooperation = {
            type: cooperationType,
            company: coopCompany,
            contact: coopContact,
            email: coopEmail,
            phone: coopPhone,
            details: coopDetails,
            timestamp: new Date().toISOString()
        };
        
        // ä¿å­˜åˆä½œä¿¡æ¯åˆ°localStorage
        let cooperations = JSON.parse(localStorage.getItem('warkAI_cooperations') || '[]');
        cooperations.push(cooperation);
        localStorage.setItem('warkAI_cooperations', JSON.stringify(cooperations));
        
        this.closeModal();
        alert('æ„Ÿè°¢æ‚¨çš„åˆä½œæ„å‘ï¼æˆ‘ä»¬ä¼šå°½å¿«ä¸æ‚¨è”ç³»ã€‚');
    }

    showCooperation() {
        const cooperationContent = `
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="menu-icon">ğŸ¤</span>
                    åˆä½œæ´½è°ˆ
                </h2>
                <p class="modal-subtitle">æ¢è®¨åˆä½œæœºä¼šï¼Œå…±åˆ›æœªæ¥</p>
                <button class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <form id="cooperationForm">
                    <div class="form-group">
                        <label class="form-label">åˆä½œç±»å‹</label>
                        <select class="form-input" id="cooperationType">
                            <option value="technology">æŠ€æœ¯åˆä½œ</option>
                            <option value="business">å•†ä¸šåˆä½œ</option>
                            <option value="investment">æŠ•èµ„æ´½è°ˆ</option>
                            <option value="partnership">æˆ˜ç•¥ä¼™ä¼´</option>
                            <option value="other">å…¶ä»–åˆä½œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å…¬å¸/ç»„ç»‡åç§°</label>
                        <input type="text" class="form-input" id="coopCompany" value="${this.currentUser?.company || ''}" placeholder="è¯·è¾“å…¥å…¬å¸æˆ–ç»„ç»‡åç§°">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è”ç³»äººå§“å</label>
                        <input type="text" class="form-input" id="coopContact" value="${this.currentUser?.name || ''}" placeholder="è¯·è¾“å…¥è”ç³»äººå§“å">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è”ç³»é‚®ç®±</label>
                        <input type="email" class="form-input" id="coopEmail" value="${this.currentUser?.email || ''}" placeholder="è¯·è¾“å…¥è”ç³»é‚®ç®±" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è”ç³»ç”µè¯</label>
                        <input type="tel" class="form-input" id="coopPhone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
                    </div>
                    <div class="form-group">
                        <label class="form-label">åˆä½œæ„å‘è¯¦æƒ…</label>
                        <textarea class="form-input form-textarea" id="coopDetails" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„åˆä½œæ„å‘ã€é¢„æœŸç›®æ ‡ç­‰..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="form-button secondary" onclick="pilotModule.closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="form-button">æäº¤ç”³è¯·</button>
                    </div>
                </form>
            </div>
        `;
        this.showModal(cooperationContent);
        
        // æ·»åŠ è¡¨å•æäº¤äº‹ä»¶
        setTimeout(() => {
            const form = document.getElementById('cooperationForm');
            if (form) {
                form.addEventListener('submit', (e) => this.submitCooperation(e));
            }
        }, 100);
    }

    submitFeedback(e) {
        e.preventDefault();
        
        const formData = {
            type: document.getElementById('feedbackType').value,
            title: document.getElementById('feedbackTitle').value,
            content: document.getElementById('feedbackContent').value,
            email: document.getElementById('feedbackEmail').value,
            timestamp: new Date().toISOString(),
            user: this.currentUser?.name || 'åŒ¿åç”¨æˆ·'
        };
        
        // ä¿å­˜åˆ°localStorage (å®é™…é¡¹ç›®ä¸­åº”è¯¥å‘é€åˆ°æœåŠ¡å™¨)
        const feedbacks = JSON.parse(localStorage.getItem('warkAI_feedbacks') || '[]');
        feedbacks.push(formData);
        localStorage.setItem('warkAI_feedbacks', JSON.stringify(feedbacks));
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        this.showSuccessMessage('åé¦ˆæäº¤æˆåŠŸ', 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šè®¤çœŸè€ƒè™‘æ‚¨çš„å»ºè®®ï¼');
    }

    submitCooperation(e) {
        e.preventDefault();
        
        const formData = {
            type: document.getElementById('cooperationType').value,
            company: document.getElementById('coopCompany').value,
            contact: document.getElementById('coopContact').value,
            email: document.getElementById('coopEmail').value,
            phone: document.getElementById('coopPhone').value,
            details: document.getElementById('coopDetails').value,
            timestamp: new Date().toISOString()
        };
        
        // ä¿å­˜åˆ°localStorage (å®é™…é¡¹ç›®ä¸­åº”è¯¥å‘é€åˆ°æœåŠ¡å™¨)
        const cooperations = JSON.parse(localStorage.getItem('warkAI_cooperations') || '[]');
        cooperations.push(formData);
        localStorage.setItem('warkAI_cooperations', JSON.stringify(cooperations));
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        this.showSuccessMessage('åˆä½œç”³è¯·æäº¤æˆåŠŸ', 'æˆ‘ä»¬ä¼šå°½å¿«ä¸æ‚¨è”ç³»ï¼Œè®¨è®ºåˆä½œè¯¦æƒ…ï¼');
    }

    showSuccessMessage(title, message) {
        const successContent = `
            <div class="modal-header">
                <h2 class="modal-title">
                    <span style="color: #00ff88;">âœ“</span>
                    ${title}
                </h2>
                <button class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; color: #00ff88; margin-bottom: 20px;">âœ“</div>
                    <p style="color: #ffffff; font-size: 16px; margin-bottom: 24px;">${message}</p>
                    <div class="modal-footer">
                        <button type="button" class="form-button" onclick="pilotModule.closeModal()">ç¡®å®š</button>
                    </div>
                </div>
            </div>
        `;
        this.showModal(successContent);
    }

    logout() {
        localStorage.removeItem('warkAI_user');
        this.currentUser = null;
        this.isLoggedIn = false;
        this.updateUI();
        this.closeModal();
        
        // æ˜¾ç¤ºç™»å‡ºæˆåŠŸæ¶ˆæ¯
        this.showSuccessMessage('ç™»å‡ºæˆåŠŸ', 'æ„Ÿè°¢ä½¿ç”¨WarkAIç³»ç»Ÿï¼ŒæœŸå¾…æ‚¨çš„å†æ¬¡è®¿é—®ï¼');
    }
}

// å…¨å±€å‡½æ•°ï¼Œä¾›HTMLè°ƒç”¨
function switchLanguage(lang) {
    const config = getLanguageConfig();
    const targetConfig = LanguageConfig[lang];
    
    if (!targetConfig) {
        console.error('ä¸æ”¯æŒçš„è¯­è¨€:', lang);
        return;
    }
    
    // ç¡®å®šå½“å‰é¡µé¢ç±»å‹
    const currentPath = window.location.pathname;
    const currentFile = currentPath.split('/').pop();
    
    let pageType = 'index';
    if (currentFile.includes('team')) pageType = 'team';
    else if (currentFile.includes('summary')) pageType = 'summary';
    else if (currentFile.includes('products')) pageType = 'products';
    else if (currentFile.includes('market')) pageType = 'market';
    else if (currentFile.includes('technology')) pageType = 'technology';
    else if (currentFile.includes('login')) pageType = 'login';
    
    // è·³è½¬åˆ°ç›®æ ‡è¯­è¨€é¡µé¢
    const targetPage = targetConfig.pages[pageType];
    if (targetPage && targetPage !== currentFile) {
        window.location.href = targetPage;
    }
}

function showLogin() {
    pilotModule.showLogin();
}

function showProfile() {
    pilotModule.showProfile();
}

function showFeedback() {
    pilotModule.showFeedback();
}

function showCooperation() {
    pilotModule.showCooperation();
}

// åˆå§‹åŒ–é©¾é©¶å‘˜æ¨¡å—
let pilotModule;

document.addEventListener('DOMContentLoaded', () => {
    pilotModule = new PilotModule();
    
    // æ›´æ–°è¯­è¨€åˆ‡æ¢å™¨æ˜¾ç¤º
    const currentLang = getCurrentLanguage();
    const langConfig = getLanguageConfig(currentLang);
    
    const langCurrent = document.getElementById('langCurrent');
    if (langCurrent && langConfig) {
        langCurrent.innerHTML = `
            <span class="lang-flag">${langConfig.flag}</span>
            <span class="lang-name">${langConfig.name}</span>
            <span class="lang-arrow">â–¼</span>
        `;
    }
});
